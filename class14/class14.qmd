---
title: "Class 14: Pathway Analysis from RNA-Seq Results"
author: Dani Baur (A16648266)
format: pdf
---

Here we run through a complete RNASeq analysis from counts to pathways and biological insight...

## Data Import

Load our data files:
```{r}
metaFile <- "GSE37704_metadata.csv"
countFile <- "GSE37704_featurecounts.csv"
```
Look at meta data:
```{r}
colData = read.csv(metaFile)
head(colData)
```

Look at count data:
```{r}
countData = read.csv(countFile, row.names=1)
head(countData)
```

**Q.** Complete the code below to remove the troublesome first column from countData
```{r}
countData <- countData[,-1]
head(countData)
```

**Q.** Complete the code below to filter countData to exclude genes (i.e. rows) where we have 0 read count across all samples (i.e. columns).
```{r}
to.keep.inds <- rowSums(countData) > 0
head(countData[to.keep.inds,])
```

## Setup for DESeq

```{r}
#| message: false
library(DESeq2)

dds <- DESeqDataSetFromMatrix(countData = countData,
                             colData = colData,
                             design = ~condition)
```
## Running DESeq

```{r}
dds <- DESeq(dds)
res <- results(dds)
```

```{r}
dds
```

**Q.** Call the summary() function on your results to get a sense of how many genes are up or down-regulated at the default 0.1 p-value cutoff.
```{r}
res = results(dds, contrast=c("condition", "hoxa1_kd", "control_sirna"))
summary(res)
```
## Visualization of results (volcano etc.)

```{r}
plot( res$log2FoldChange, -log(res$padj))
```
**Q.** Improve this plot by completing the below code, which adds color and axis labels

```{r}
mycols <- rep("gray", nrow(res) )
mycols[ abs(res$log2FoldChange) > 2 ] <- "red"
inds <- (abs(res$padj) < 0.01) & (abs(res$log2FoldChange) > 2 )
mycols[inds] <- "blue"
plot( res$log2FoldChange, -log(res$padj), col=mycols, xlab="Log2(FoldChange)", ylab="-Log(P-value)" )
```
## Add gene annotation data (gene names etc.)

**Q.** Use the mapIDs() function multiple times to add SYMBOL, ENTREZID and GENENAME annotation to our results by completing the code below.
```{r}
library("AnnotationDbi")
library("org.Hs.eg.db")

columns(org.Hs.eg.db)

res$symbol = mapIds(org.Hs.eg.db,
                    keys=rownames(res), 
                    keytype="ENSEMBL",
                    column="SYMBOL",
                    multiVals="first")

res$entrez = mapIds(org.Hs.eg.db,
                    keys=rownames(res),
                    keytype="ENSEMBL",
                    column="ENTREZID",
                    multiVals="first")

res$name =   mapIds(org.Hs.eg.db,
                    keys=row.names(res),
                    keytype="ENSEMBL",
                    column="GENENAME",
                    multiVals="first")

head(res, 10)
```
## Save our results

```{r}
ord <- order(res$padj)
head(res[ord,])
```

```{r}
write.csv(res[ord,], "deseq_results.csv")
```

## Pathway analysis

```{r}
#| message: false
library(pathview)
library(gage)
library(gageData)
```

### KEGG

```{r}
data(kegg.sets.hs)
data(sigmet.idx.hs)
kegg.sets.hs = kegg.sets.hs[sigmet.idx.hs]
head(kegg.sets.hs, 3)
```

```{r}
foldchanges = res$log2FoldChange
names(foldchanges) = res$entrez
head(foldchanges)
```

```{r}
keggres = gage(foldchanges, gsets=kegg.sets.hs)
attributes(keggres)
```

```{r}
head(keggres$less)
```

```{r}
pathview(gene.data=foldchanges, pathway.id="hsa04110")
```

![](hsa04110.pathview.png)

### Gene Ontology (GO)
```{r}
data(go.sets.hs)
data(go.subs.hs)
gobpsets = go.sets.hs[go.subs.hs$BP]
gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)
lapply(gobpres, head)
```

### Reactome Analysis

```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
print(paste("Total number of significant genes:", length(sig_genes)))
```
```{r}
write.table(sig_genes, file="significant_genes.txt", row.names=FALSE, col.names=FALSE, quote=FALSE)
```

**Q.** What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

![](R-HSA-453274.png)

The pathway with the most significant "Entities p-value" is the "regulation of PLK1 activity at G2/M transition" in the cell cycle. Yes, this matches the results from the KEGG results that indicated the cell cycle as well. Differences from the two methods could stem from how the data is collected and analyzed.
